<?php
/**
 * Admin functionality for Form Settings
 */

if (!defined('ABSPATH')) {
    exit;
}

class Form_Settings_Admin
{

    /**
     * Constructor
     */
    public function __construct()
    {
        // Hook where you render tabs / admin UI
        add_action('admin_menu', [$this, 'register_menu']);
    }

    /**
     * Register admin menu
     */
    public function register_menu()
    {
        add_menu_page(
            __('Form Settings', 'form-settings'),
            __('Form Settings', 'form-settings'),
            'manage_options',
            'form-settings',
            [$this, 'render_admin_page'],
            'dashicons-feedback',
            56
        );
    }

    /**
     * Render admin page
     */
    public function render_admin_page()
    {
        ?>
        <div class="wrap">
            <h1><?php esc_html_e('Form Settings', 'form-settings'); ?></h1>

            <?php
            // Render Error Log tab directly for now
            $this->render_error_log_tab();
            ?>
        </div>
        <?php
    }

    /**
     * Render Error Log tab
     */
    private function render_error_log_tab()
    {
        $error_logger = new Form_Settings_Error_Logger();

        $logs = $error_logger->get_logs();
        $stats = $error_logger->get_statistics();

        // Safe defaults
        $stats = is_array($stats) ? $stats : [];
        $stats = array_merge(
            [
                'total' => 0,
                'by_type' => [
                    'validation' => 0,
                    'spam' => 0,
                    'mail' => 0,
                    'field' => 0,
                ],
            ],
            $stats
        );

        $stats['by_type'] = array_merge(
            [
                'validation' => 0,
                'spam' => 0,
                'mail' => 0,
                'field' => 0,
            ],
            $stats['by_type'] ?? []
        );

        // CF7 forms
        $forms = get_posts([
            'post_type' => 'wpcf7_contact_form',
            'posts_per_page' => -1,
            'post_status' => 'publish',
        ]);
        ?>

        <h2><?php esc_html_e('Error Log', 'form-settings'); ?></h2>

        <p><?php esc_html_e('View and manage form submission errors.', 'form-settings'); ?></p>

        <!-- Statistics -->
        <div style="background:#f9f9f9;padding:20px;margin:20px 0;border-radius:5px;">
            <h3><?php esc_html_e('Error Statistics', 'form-settings'); ?></h3>
            <ul>
                <li><?php esc_html_e('Total:', 'form-settings'); ?>         <?php echo esc_html($stats['total']); ?></li>
                <li><?php esc_html_e('Validation:', 'form-settings'); ?>
                    <?php echo esc_html($stats['by_type']['validation']); ?></li>
                <li><?php esc_html_e('Spam:', 'form-settings'); ?>         <?php echo esc_html($stats['by_type']['spam']); ?></li>
                <li><?php esc_html_e('Mail:', 'form-settings'); ?>         <?php echo esc_html($stats['by_type']['mail']); ?></li>
                <li><?php esc_html_e('Field:', 'form-settings'); ?>         <?php echo esc_html($stats['by_type']['field']); ?></li>
            </ul>
        </div>

        <!-- Error Table -->
        <?php if (empty($logs)): ?>
            <p><?php esc_html_e('No errors logged yet.', 'form-settings'); ?></p>
        <?php else: ?>
            <table class="wp-list-table widefat striped">
                <thead>
                    <tr>
                        <th><?php esc_html_e('Date', 'form-settings'); ?></th>
                        <th><?php esc_html_e('Type', 'form-settings'); ?></th>
                        <th><?php esc_html_e('Form', 'form-settings'); ?></th>
                        <th><?php esc_html_e('Message', 'form-settings'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($logs as $log): ?>
                        <tr>
                            <td><?php echo esc_html(wp_date('Y-m-d H:i:s', strtotime($log['timestamp'] ?? ''))); ?></td>
                            <td><?php echo esc_html($log['type'] ?? ''); ?></td>
                            <td><?php echo esc_html($log['form_title'] ?? ''); ?></td>
                            <td><?php echo esc_html($log['message'] ?? ''); ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>

        <?php
    }
}

/**
 * Boot the admin
 */
new Form_Settings_Admin();